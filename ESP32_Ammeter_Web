#include <WiFi.h>
#include <WebServer.h>

const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

const int sensorPin = 34;  // Analog input pin for JIHE11 output
float sensitivity = 0.100; // V/A (adjust for your sensor)
float offset = 2.5;        // Zero current voltage (adjust after testing)

WebServer server(80);

String htmlPage(float current) {
  String html = "<!DOCTYPE html><html><head><meta http-equiv='refresh' content='2'>";
  html += "<title>ESP32 Ammeter</title>";
  html += "<style>body{font-family:Arial;text-align:center;margin-top:50px;}";
  html += "h1{color:#007BFF;}p{font-size:24px;}</style></head><body>";
  html += "<h1>ESP32 Current Meter</h1>";
  html += "<p>Current: " + String(current, 2) + " A</p>";
  html += "</body></html>";
  return html;
}

void handleRoot() {
  int adcValue = analogRead(sensorPin);
  float voltage = (adcValue / 4095.0) * 3.3;  // ESP32 ADC 12-bit, 3.3V ref
  float current = (voltage - offset) / sensitivity;
  server.send(200, "text/html", htmlPage(current));
}

void setup() {
  Serial.begin(115200);
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nConnected!");
  Serial.print("ESP32 IP Address: ");
  Serial.println(WiFi.localIP());

  server.on("/", handleRoot);
  server.begin();
  Serial.println("Web server started.");
}

void loop() {
  server.handleClient();
}
